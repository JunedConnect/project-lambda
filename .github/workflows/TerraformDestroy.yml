name: Terraform Destroy

on:
  workflow_dispatch:

# on:
#     push:
#         branches:
#             - dev


jobs:
    terraformdestroy:
        runs-on: ubuntu-24.04
        defaults:
            run:
                working-directory: "./terraform"
        permissions:
            id-token: write   # This is required for requesting the JWT
    
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Login to AWS
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ vars.AWS_GITHUB_ROLE_ARN }}
                role-session-name: github-actions-session
                aws-region: eu-west-2

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.11.1

            - name: Terraform Init
              run: terraform init

            - name: Empty S3 bucket
              run: |
                BUCKET_NAME=$(terraform output -raw s3_bucket_name)
                aws s3 rm s3://$BUCKET_NAME --recursive --include-versions

            - name: Terraform Destroy
              run: terraform destroy -auto-approve
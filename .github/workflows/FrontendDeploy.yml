name: Frontend Code Upload to S3

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose which environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
    frontend-upload-dev:
        runs-on: ubuntu-20.04
        if: ${{ inputs.environment == 'dev' }}
        defaults:
            run:
                working-directory: "./terraform/environments/dev"
        permissions:
            id-token: write   # This is required for requesting the JWT
    
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Login to AWS
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ vars.AWS_GITHUB_ROLE_ARN }}
                role-session-name: github-actions-frontend-upload
                aws-region: eu-west-2

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.11.1

            - name: Terraform Init
              run: terraform init

            - name: Get Terraform Outputs
              id: terraform
              run: |
                BUCKET_NAME=$(terraform output -raw s3_bucket_name)
                API_URL=$(terraform output -raw api_gateway_url)

            - name: Upload to S3
              working-directory: "./frontend"
              shell: bash
              run: |
                sed -i "s|const API_BASE_URL = '';|const API_BASE_URL = '${{ steps.terraform.outputs.api_url }}';|g" index.html
                sed -i "s|const API_BASE_URL = '';|const API_BASE_URL = '${{ steps.terraform.outputs.api_url }}';|g" health.html
                aws s3 sync . "s3://${{ steps.terraform.outputs.bucket_name }}" --delete

    frontend-upload-prod:
        runs-on: ubuntu-20.04
        if: ${{ inputs.environment == 'prod' }}
        defaults:
            run:
                working-directory: "./terraform/environments/prod"
        permissions:
            id-token: write   # This is required for requesting the JWT
    
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Login to AWS
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ vars.AWS_GITHUB_ROLE_ARN }}
                role-session-name: github-actions-frontend-upload
                aws-region: eu-west-2

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.11.1

            - name: Terraform Init
              run: terraform init

            - name: Get Terraform Outputs
              id: terraform
              run: |
                BUCKET_NAME=$(terraform output -raw s3_bucket_name)
                API_URL=$(terraform output -raw api_gateway_url)

            - name: Upload to S3
              working-directory: "./frontend"
              shell: bash
              run: |
                sed -i "s|const API_BASE_URL = '';|const API_BASE_URL = '${{ steps.terraform.outputs.api_url }}';|g" index.html
                sed -i "s|const API_BASE_URL = '';|const API_BASE_URL = '${{ steps.terraform.outputs.api_url }}';|g" health.html
                aws s3 sync . "s3://${{ steps.terraform.outputs.bucket_name }}" --delete


